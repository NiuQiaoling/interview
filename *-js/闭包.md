## 闭包

定义闭包：

- 在函数内部定义新函数

- 新函数访问外层函数的局部变量，即访问外层函数环境的活动对象属性

- 新函数执行，创建新的函数执行上下文，外层函数即为闭包

> 闭包是函数和声明函数的词法环境的组合 - MDN

    ECMAScript中，闭包指的是：

    从理论角度：所有的函数。因为它们都在创建的时候就将上层上下文的数据保存起来了。哪怕是简单的全局变量也是如此，因为函数中访问全局变量就相当于是在访问自由变量，这个时候使用最外层的作用域。

    从实践角度：以下函数才算是闭包：
    即使创建它的上下文已经销毁，它仍然存在（比如，内部函数从父函数中返回）
    在代码中引用了自由变量

看到这个实践角度的闭包， 是不是有点似成相识， 没错， 这不就是我们上一篇讲到的[嵌套函数](./嵌套函数.md)的一些特点嘛。 我们再来举个例子， 了解一下

    var name = 'g';
    function f1() {
        var name = 'a';
        function f2() {
            return name;
        }
        return f2
    }
    var n = f1();
    n();

简述一下过程
- 代码下载完成， 创建全局执行上下文， 推入执行上下文栈中
- 初始化全局执行上下文， 创建作用域链， 变量对象， this指向
- 执行代码， 调用f1函数
- 创建函数f1执行上下文， 推入执行上下文栈中
- 初始化函数f1执行上下文， 创建作用域链， 变量对象， this指向
- 执行代码， 返回函数f2, 函数f1执行完毕， 从执行上下文栈中弹出
- 执行函数n(变量n指向f2), 创建函数n执行上下文， 推入栈中
- 初始化函数n执行上下文， 创建函数作用域链， 变量对象， this指向
- 执行函数f2， 返回name, 在f2变量对象中找不到name属性， 则到fu执行上下文变量对象中查找
- 调用结束， 函数f2执行上下文出栈
- 全局执行上下文出栈

过程中， 我们可能注意到一点， 在调用f2的时候， f1执行上下文已经出栈， 那么又是怎么找到变量name的呢? 

其实， 还是在[执行上下文](./执行上下文.md) 一章中提到的， 

函数定义的时候， 函数对象属性[[scope]]保存当前所有父变量对象（词法上的父级）， 而执行上下文变量对象的作用域链正式根据[[scope]]属性和活动对象生成的， 所以父级执行上下文出栈并不影响子函数的执行， 因为自函数在定义的时候已经保存词法作用域上所有父级的变量对象了

那么嵌套函数与闭包到底有什么联系呢? 很明显， 闭包是嵌套函数的一种实现， 嵌套函数包含闭包

## 定义
**通俗地讲， 闭包是指在javascript中， 内部函数总是可以访问其所在的外部函数中声明的参数和变量， 即使在其外部函数被返回了之后**

## 特点
- 闭包可以被延迟执行(返回内部函数后， 可以在需要的时候再执行)
- 函数嵌套函数
- 函数内部可以引用外部的参数和变量
- 参数和变量不会被垃圾回收机制回收
    
    - 这也是导致内存增大/内存泄漏的一个原因
    - 这也是创建私有变量和方法的一个实现(看下面的例子)

            function f() {
                var count = 0;
                function addCount() {
                    count += 1;
                    return count;
                }
                return addCount;
            }
            var f1 = f();
            f1(); // 1
            f1(); // 2
            ...


## 使用场景
那么闭包有什么使用场景呢?
1. 自执行函数

        var f = (function() {
            var count = 0;
            
            return {
                getCount: function() {
                    return count;
                },
                addCount: function() {
                    count += 1;
                }
            }
        })()

